<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise de Movimento Aeronáutico - Sistema Avançado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-statistics@7.8.3/dist/simple-statistics.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        /* CSS sem alterações */
        ::-webkit-scrollbar { width: 6px; height: 6px; } ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 3px; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; } ::-webkit-scrollbar-thumb:hover { background: #94a3b8; } body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; } .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); } .glass-dark { background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); } @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } } @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } } .animate-fadeInUp { animation: fadeInUp 0.6s ease-out; } .animate-pulse-custom { animation: pulse 2s infinite; } .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); } .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); } .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); transition: all 0.3s ease; } .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4); } .btn-secondary { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); transition: all 0.3s ease; } .btn-secondary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(240, 147, 251, 0.4); } .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; } .stat-card-green { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); } .stat-card-orange { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); } .stat-card-purple { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #1f2937; } .spinner { border-top-color: transparent; animation: spin 1s linear infinite; } @keyframes spin { to { transform: rotate(360deg); } } #toast { transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); } .table-row:hover { background: linear-gradient(90deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); } .chart-container { position: relative; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); }
        .table-filter-input {
            width: 100%; padding: 4px 8px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 12px;
        }
        .table-filter-input:focus {
            border-color: #667eea; outline: none; box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        @media print {
            body { background: #fff; }
            .no-print { display: none !important; }
            main, .xl\:col-span-3, .xl\:col-span-1 { display: block !important; grid-column: span 12 / span 12 !important; }
            .glass { box-shadow: none !important; border: 1px solid #ddd !important; background: #fff !important; margin-bottom: 20px; page-break-inside: avoid; }
            h1, h2, h3 { color: #000 !important; }
            .bg-clip-text { color: transparent !important; }
        }
    </style>
</head>
<body>
    <div id="login-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50"><div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center"><h2 class="text-2xl font-bold mb-4 text-gray-800">Acesso ao Sistema</h2><p class="text-gray-600 mb-6">Por favor, faça login para continuar.</p><form id="loginForm" class="space-y-4"><input type="email" id="email" placeholder="Seu e-mail" required class="w-full px-4 py-2 border rounded-lg"><input type="password" id="password" placeholder="Sua senha" required class="w-full px-4 py-2 border rounded-lg"><button type="submit" class="w-full btn-primary text-white font-semibold py-3 px-4 rounded-xl">Entrar</button></form><p id="login-error" class="text-red-500 mt-4 text-sm"></p></div></div><div id="user-info" class="hidden no-print fixed top-5 right-5 glass-dark text-white py-2 px-4 rounded-xl shadow-lg z-50 flex items-center gap-4"><span id="user-email" class="text-sm"></span><button id="logoutButton" class="bg-red-500 hover:bg-red-600 rounded-full w-8 h-8 flex items-center justify-center"><i data-lucide="log-out" class="w-4 h-4 text-white"></i></button></div><div id="main-app" class="hidden"><div class="fixed inset-0 overflow-hidden pointer-events-none no-print"><div class="absolute -top-40 -right-40 w-80 h-80 bg-white opacity-10 rounded-full blur-3xl"></div><div class="absolute -bottom-40 -left-40 w-80 h-80 bg-white opacity-10 rounded-full blur-3xl"></div></div><div id="app" class="relative z-10 container mx-auto p-4 md:p-6 lg:p-8 max-w-7xl"><header class="glass rounded-2xl p-6 mb-8 card-hover animate-fadeInUp"><div class="flex flex-wrap items-center justify-between gap-4"><div class="flex items-center"><div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center mr-4 animate-pulse-custom no-print"><i data-lucide="plane" class="w-6 h-6 text-white"></i></div><div><h1 class="text-3xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent">Análise de Tráfego Aéreo</h1><p class="text-gray-600 text-sm">Sistema Avançado de Monitoramento</p><p id="data-period-display" class="text-sm text-indigo-800 font-medium mt-1"></p></div></div><div class="flex items-center space-x-2"><div class="w-3 h-3 bg-green-400 rounded-full animate-pulse no-print"></div><span class="text-sm text-gray-600">Sistema Online</span></div></div></header><main class="grid grid-cols-1 xl:grid-cols-4 gap-8"><div class="xl:col-span-1 space-y-6"><div class="glass rounded-2xl p-6 card-hover animate-fadeInUp no-print" style="animation-delay: 0.1s"><div class="flex items-center mb-4"><div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mr-3"><i data-lucide="upload" class="w-4 h-4 text-white"></i></div><h2 class="text-xl font-semibold text-gray-800">Upload de Dados</h2></div><form id="uploadForm" class="space-y-4"><div class="relative"><input type="file" id="dataFile" accept=".dat,.dta" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" multiple><div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-blue-400 transition-colors"><i data-lucide="file-text" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i><p id="file-upload-text" class="text-sm text-gray-600">Clique ou arraste o(s) arquivo(s) .dat</p><p class="text-xs text-gray-400 mt-1">Máximo 10MB</p></div></div><button id="uploadButton" type="submit" class="w-full btn-primary text-white font-semibold py-3 px-4 rounded-xl disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"><span id="button-text">Processar Arquivo(s)</span><div id="loading-spinner" class="spinner w-5 h-5 border-4 border-white rounded-full hidden"></div></button></form></div><div class="glass rounded-2xl p-6 card-hover animate-fadeInUp no-print" style="animation-delay: 0.15s"><div class="flex items-center mb-4"><div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-lg flex items-center justify-center mr-3"><i data-lucide="history" class="w-4 h-4 text-white"></i></div><h2 class="text-xl font-semibold text-gray-800">Histórico de Uploads</h2></div><div id="upload-history-list" class="space-y-2 max-h-60 overflow-y-auto pr-2"><p class="text-sm text-gray-500 text-center py-4">Carregando histórico...</p></div></div><div class="glass rounded-2xl p-6 card-hover animate-fadeInUp no-print" style="animation-delay: 0.2s"><div class="flex items-center mb-4"><div class="w-8 h-8 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center mr-3"><i data-lucide="sliders-horizontal" class="w-4 h-4 text-white"></i></div><h2 class="text-xl font-semibold text-gray-800">Painel de Controle</h2></div><div class="space-y-4"><label class="block text-sm font-medium text-gray-700">Período de Análise</label><div class="space-y-2"><input type="date" id="analysisStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg"><input type="date" id="analysisEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></div><button id="runAnalysisButton" class="w-full btn-primary text-white font-semibold py-3 px-4 rounded-xl flex items-center justify-center gap-2"><i data-lucide="bar-chart-2" class="w-4 h-4"></i><span>Analisar Período</span></button><button id="printReportButton" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center gap-2"><i data-lucide="printer" class="w-4 h-4"></i> Gerar Relatório</button></div></div><div class="glass rounded-2xl p-6 card-hover animate-fadeInUp" style="animation-delay: 0.3s"><div class="flex items-center mb-4"><div class="w-8 h-8 bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-lg flex items-center justify-center mr-3"><i data-lucide="alert-triangle" class="w-4 h-4 text-white"></i></div><h2 class="text-xl font-semibold text-gray-800">Alertas e Insights</h2></div><ul id="anomaly-alerts-list" class="space-y-2 text-sm text-gray-600 max-h-40 overflow-y-auto pr-2 mb-4 border-b pb-4"><li>Nenhum dado carregado.</li></ul><div class="space-y-3"><div class="flex justify-between items-center"><span class="text-sm text-gray-600">Registros Carregados</span><span id="loaded-count" class="font-semibold text-blue-600">0</span></div><div class="flex justify-between items-center"><span class="text-sm text-gray-600">Filtros Ativos</span><span id="active-filters" class="font-semibold text-green-600">0</span></div><div class="flex justify-between items-center"><span class="text-sm text-gray-600">Última Atualização</span><span id="last-update" class="font-semibold text-gray-600">-</span></div></div></div></div><div class="xl:col-span-3 space-y-6"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 animate-fadeInUp" style="animation-delay: 0.4s"><div class="stat-card rounded-2xl p-6 card-hover"><div class="flex items-center justify-between"><div><p class="text-white/80 text-sm">Total de Voos</p><p id="total-voos" class="text-3xl font-bold text-white">0</p></div><i data-lucide="plane" class="w-8 h-8 text-white/60"></i></div></div><div class="stat-card-green rounded-2xl p-6 card-hover"><div class="flex items-center justify-between"><div><p class="text-white/80 text-sm">Voos Comerciais</p><p id="voos-comerciais" class="text-3xl font-bold text-white">0</p></div><i data-lucide="building" class="w-8 h-8 text-white/60"></i></div></div><div class="stat-card-orange rounded-2xl p-6 card-hover"><div class="flex items-center justify-between"><div><p class="text-white/80 text-sm">Sobrevoos</p><p id="sobrevoos" class="text-3xl font-bold text-white">0</p></div><i data-lucide="git-commit" class="w-8 h-8 text-white/60"></i></div></div><div class="stat-card-purple rounded-2xl p-6 card-hover"><div class="flex items-center justify-between"><div><p class="text-gray-700/80 text-sm">Horário de Pico</p><p id="horario-pico" class="text-3xl font-bold text-gray-800">-</p></div><i data-lucide="trending-up" class="w-8 h-8 text-gray-600"></i></div></div></div><div class="glass rounded-2xl p-6 card-hover chart-container animate-fadeInUp" style="animation-delay: 0.5s"><h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center"><i data-lucide="line-chart" class="w-5 h-5 mr-2 text-teal-500"></i> Projeção de Tráfego Mensal</h3><div class="relative" style="height: 300px;"><canvas id="trafficProjectionChart"></canvas></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6 animate-fadeInUp" style="animation-delay: 0.6s"><div class="glass rounded-2xl p-6 card-hover chart-container"><h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center"><i data-lucide="pie-chart" class="w-5 h-5 mr-2 text-blue-500"></i> Voos por Regra</h3><div class="relative h-64"><canvas id="flightsByRuleChart"></canvas></div></div><div class="glass rounded-2xl p-6 card-hover chart-container"><h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center"><i data-lucide="map-pin" class="w-5 h-5 mr-2 text-green-500"></i> Destinos Principais</h3><div class="relative h-64"><canvas id="flightsByDestChart"></canvas></div></div></div><div class="glass rounded-2xl p-6 card-hover chart-container animate-fadeInUp" style="animation-delay: 0.7s"><h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center"><i data-lucide="clock" class="w-5 h-5 mr-2 text-purple-500"></i> Distribuição por Horário</h3><div class="relative" style="height: 300px;"><canvas id="hourlyFlightsChart"></canvas></div></div><div class="glass rounded-2xl p-6 card-hover chart-container animate-fadeInUp" style="animation-delay: 0.8s"><h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center"><i data-lucide="calendar-days" class="w-5 h-5 mr-2 text-red-500"></i> Movimento por Dia da Semana</h3><div class="relative" style="height: 300px;"><canvas id="dayOfWeekChart"></canvas></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6 animate-fadeInUp" style="animation-delay: 0.9s"><div class="glass rounded-2xl p-6 card-hover chart-container"><h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center"><i data-lucide="pie-chart" class="w-5 h-5 mr-2 text-cyan-500"></i> Utilização das Pistas</h3><div class="relative h-64"><canvas id="runwayUsageChart"></canvas></div></div><div class="glass rounded-2xl p-6 card-hover chart-container"><h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center"><i data-lucide="calendar" class="w-5 h-5 mr-2 text-amber-500"></i> Tendência Mensal</h3><div class="relative h-64"><canvas id="monthlyTrendsChart"></canvas></div></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6 animate-fadeInUp" style="animation-delay: 1.0s"><div class="glass rounded-2xl p-6 card-hover chart-container"><h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center"><i data-lucide="plane-takeoff" class="w-5 h-5 mr-2 text-lime-500"></i> Top 5 Aeronaves</h3><div class="relative h-64"><canvas id="aircraftTypesChart"></canvas></div></div><div class="glass rounded-2xl p-6 card-hover chart-container"><h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center"><i data-lucide="users" class="w-5 h-5 mr-2 text-fuchsia-500"></i> Top 5 Operadores</h3><div class="relative h-64"><canvas id="operatorChart"></canvas></div></div></div><div class="glass rounded-2xl p-6 card-hover animate-fadeInUp" style="animation-delay: 1.1s"><div class="flex flex-wrap items-center justify-between mb-6 gap-4"><h3 class="text-lg font-semibold text-gray-800 flex items-center"><i data-lucide="table" class="w-5 h-5 mr-2 text-indigo-500"></i> Registros de Voo</h3><div class="flex items-center gap-2"><button id="saveToCloudButton" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg text-sm font-medium flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed no-print" disabled><i data-lucide="cloud-upload" class="w-4 h-4"></i> Salvar na Nuvem</button><button id="downloadCsvButton" class="btn-secondary text-white py-2 px-4 rounded-lg text-sm font-medium flex items-center gap-2 no-print"><i data-lucide="download" class="w-4 h-4"></i> Download CSV</button></div></div><div class="overflow-auto rounded-xl border border-gray-200" style="max-height: 500px;"><table class="w-full text-sm"><thead class="bg-gray-50 sticky top-0"><tr class="no-print"><th class="px-4 py-3 text-left font-semibold text-gray-700">Data/Hora (UTC)</th><th class="px-4 py-3 text-left font-semibold text-gray-700">Matrícula</th><th class="px-4 py-3 text-left font-semibold text-gray-700">Tipo Aeronave</th><th class="px-4 py-3 text-left font-semibold text-gray-700">Tipo Voo</th><th class="px-4 py-3 text-left font-semibold text-gray-700">Origem</th><th class="px-4 py-3 text-left font-semibold text-gray-700">Destino</th><th class="px-4 py-3 text-left font-semibold text-gray-700">Regra</th><th class="px-4 py-3 text-left font-semibold text-gray-700">Pista</th></tr><tr id="table-filters" class="no-print"><th class="px-2 py-2"><input type="text" placeholder="Filtrar..." data-column="timestamp" class="table-filter-input"></th><th class="px-2 py-2"><input type="text" placeholder="Filtrar..." data-column="matricula" class="table-filter-input"></th><th class="px-2 py-2"><input type="text" placeholder="Filtrar..." data-column="tipo_aeronave" class="table-filter-input"></th><th class="px-2 py-2"><input type="text" placeholder="Filtrar..." data-column="flight_class" class="table-filter-input"></th><th class="px-2 py-2"><input type="text" placeholder="Filtrar..." data-column="origem" class="table-filter-input"></th><th class="px-2 py-2"><input type="text" placeholder="Filtrar..." data-column="destino" class="table-filter-input"></th><th class="px-2 py-2"><input type="text" placeholder="Filtrar..." data-column="regra_voo" class="table-filter-input"></th><th class="px-2 py-2"><input type="text" placeholder="Filtrar..." data-column="pista" class="table-filter-input"></th></tr></thead><tbody id="dataTableBody"><tr><td colspan="8" class="text-center p-12 text-gray-500"><i data-lucide="inbox" class="w-12 h-12 mx-auto mb-4 text-gray-300"></i><p>Aguardando análise de período...</p></td></tr></tbody></table></div></div></div></main></div></div>
    
    <div id="toast" class="fixed top-5 right-5 glass-dark text-white py-3 px-6 rounded-xl shadow-lg opacity-0 transform translate-y-[-20px] z-50">
        <div class="flex items-center gap-3">
            <i id="toast-icon" data-lucide="check-circle" class="w-5 h-5"></i>
            <span id="toast-message"></span>
        </div>
    </div>

    <script>
        // ... (Bloco de configuração e autenticação do Firebase sem alterações) ...
        const firebaseConfig = { apiKey: "AIzaSyA2EFVZ9UOQcUo_bDlhvSTWXnBDYv-GBGk", authDomain: "analise-trafego-aereo.firebaseapp.com", projectId: "analise-trafego-aereo", storageBucket: "analise-trafego-aereo.appspot.com", messagingSenderId: "848119246677", appId: "1:848119246677:web:cf94faf95dea6cfbea49dc", measurementId: "G-CFJ1PGBR52" }; firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const loginOverlay = document.getElementById('login-overlay'); const mainApp = document.getElementById('main-app'); const loginForm = document.getElementById('loginForm'); const loginError = document.getElementById('login-error'); const userInfo = document.getElementById('user-info'); const userEmail = document.getElementById('user-email'); const logoutButton = document.getElementById('logoutButton');
        
        // vvvvvv BLOCO DE CÓDIGO CONSOLIDADO E CORRIGIDO vvvvvv
        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged(user => {
                if (user) {
                    loginOverlay.classList.add('hidden');
                    mainApp.classList.remove('hidden');
                    userInfo.classList.remove('hidden');
                    userEmail.textContent = user.email;
                    fetchUploadHistory(); // Agora a função existe e será chamada
                } else {
                    loginOverlay.classList.remove('hidden');
                    mainApp.classList.add('hidden');
                    userInfo.classList.add('hidden');
                }
                lucide.createIcons();
            });
            loginForm.addEventListener('submit', (e) => { e.preventDefault(); const email = document.getElementById('email').value; const password = document.getElementById('password').value; loginError.textContent = ''; auth.signInWithEmailAndPassword(email, password).catch(error => { console.error('Erro de login:', error); loginError.textContent = 'E-mail ou senha inválidos.'; }); });
            logoutButton.addEventListener('click', () => { auth.signOut(); });

            lucide.createIcons();
            let allFlightData = []; let currentIcaoCode = null; let currentDataDate = null;
            let flightsByRuleChart, flightsByDestChart, hourlyFlightsChart, dayOfWeekChart, monthlyTrendsChart, runwayUsageChart, aircraftTypesChart, operatorChart, trafficProjectionChart;
            
            const uploadForm = document.getElementById('uploadForm'); const dataFile = document.getElementById('dataFile'); const uploadButton = document.getElementById('uploadButton'); const buttonText = document.getElementById('button-text'); const loadingSpinner = document.getElementById('loading-spinner'); const tableBody = document.getElementById('dataTableBody');
            const downloadCsvButton = document.getElementById('downloadCsvButton'); const saveToCloudButton = document.getElementById('saveToCloudButton'); const uploadHistoryList = document.getElementById('upload-history-list');
            const analysisStartDate = document.getElementById('analysisStartDate'); const analysisEndDate = document.getElementById('analysisEndDate'); const runAnalysisButton = document.getElementById('runAnalysisButton'); const printReportButton = document.getElementById('printReportButton');
            const anomalyAlertsList = document.getElementById('anomaly-alerts-list');
            const tableFilters = document.querySelectorAll('#table-filters .table-filter-input');
            const fileUploadText = document.getElementById('file-upload-text');

            function showToast(message, type = 'success') { const toast = document.getElementById('toast'); const toastMessage = document.getElementById('toast-message'); const toastIcon = document.getElementById('toast-icon'); toastMessage.textContent = message; if (type === 'error') { toastIcon.setAttribute('data-lucide', 'x-circle'); toast.className = toast.className.replace('glass-dark', 'bg-red-500'); } else { toastIcon.setAttribute('data-lucide', 'check-circle'); toast.className = toast.className.replace('bg-red-500', 'glass-dark'); } lucide.createIcons(); toast.style.opacity = '1'; toast.style.transform = 'translateY(0)'; setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateY(-20px)'; }, 3000); }
            function formatDateTime(isoString) { if (!isoString) return '<span class="text-red-500">Inválido</span>'; try { const date = new Date(isoString); const day = String(date.getUTCDate()).padStart(2, '0'); const month = String(date.getUTCMonth() + 1).padStart(2, '0'); const year = date.getUTCFullYear(); const hours = String(date.getUTCHours()).padStart(2, '0'); const minutes = String(date.getUTCMinutes()).padStart(2, '0'); return `${day}/${month}/${year}, ${hours}:${minutes}`; } catch (e) { return '<span class="text-red-500">Inválido</span>'; } }
            function updateDataPeriodDisplay(startDateStr, endDateStr) { const displayElement = document.getElementById('data-period-display'); if (!startDateStr) { displayElement.innerHTML = ''; return; } try { const start = new Date(startDateStr + 'T12:00:00Z'); const end = new Date(endDateStr + 'T12:00:00Z'); const startMonth = start.toLocaleString('pt-BR', { month: 'long', timeZone: 'UTC' }); const startYear = start.getUTCFullYear(); const endMonth = end.toLocaleString('pt-BR', { month: 'long', timeZone: 'UTC' }); const endYear = end.getUTCFullYear(); let periodText; if (startMonth === endMonth && startYear === endYear) { periodText = `${startMonth.charAt(0).toUpperCase() + startMonth.slice(1)} de ${startYear}`; } else { periodText = `De ${start.toLocaleDateString('pt-BR', {timeZone: 'UTC'})} a ${end.toLocaleDateString('pt-BR', {timeZone: 'UTC'})}`; } displayElement.innerHTML = `Exibindo dados de: <strong class="font-semibold">${periodText}</strong>`; } catch (e) { displayElement.innerHTML = ''; } }
            
            async function runAnalysis() {
                const startDate = analysisStartDate.value; const endDate = analysisEndDate.value;
                if (!startDate || !endDate) { showToast('Por favor, selecione as datas de início e fim.', 'error'); return; }
                showToast('Buscando e consolidando dados...', 'success'); runAnalysisButton.disabled = true;
                try {
                    const user = auth.currentUser; if (!user) { throw new Error('Sessão expirada.'); }
                    const token = await user.getIdToken();
                    const response = await fetch(`/api/get_aggregated_data?start_date=${startDate}&end_date=${endDate}`, { headers: { 'Authorization': 'Bearer ' + token } });
                    if (!response.ok) { const err = await response.json(); throw new Error(err.error || "Falha ao buscar dados consolidados"); }
                    const records = await response.json();
                    allFlightData = records;
                    allFlightData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    updateDataPeriodDisplay(startDate, endDate);
                    applyFiltersAndRender();
                    updateStatus();
                    showToast(`${records.length} registros totais carregados para o período!`, 'success');
                } catch (error) { console.error('Erro na análise:', error); showToast(error.message, 'error');
                } finally { runAnalysisButton.disabled = false; }
            }
            runAnalysisButton.addEventListener('click', runAnalysis);
            printReportButton.addEventListener('click', () => { window.print(); });

            uploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (dataFile.files.length === 0) {
                    showToast('Por favor, selecione um ou mais arquivos.', 'error');
                    return;
                }
                
                const formData = new FormData();
                for (const file of dataFile.files) {
                    formData.append('dataFiles', file);
                }

                toggleLoading(true);
                try {
                    const user = auth.currentUser;
                    if (!user) { throw new Error('Sessão expirada. Faça login novamente.'); }
                    const token = await user.getIdToken();
                    const response = await fetch('/api/upload', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token }, body: formData });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Erro no servidor');
                    }
                    const data = await response.json();
                    allFlightData = data.records;
                    currentIcaoCode = data.icao_code;
                    currentDataDate = data.data_date;
                    allFlightData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    updateDataPeriodDisplay(currentDataDate, currentDataDate);
                    applyFiltersAndRender();
                    updateStatus();
                    showToast(`${allFlightData.length} registros carregados com sucesso!`, 'success');
                    saveToCloudButton.disabled = false;
                } catch (error) {
                    console.error('Erro no upload:', error);
                    showToast(error.message, 'error');
                } finally {
                    toggleLoading(false);
                    dataFile.value = ''; // Limpa a seleção de arquivos
                    fileUploadText.textContent = 'Clique ou arraste o(s) arquivo(s) .dat';
                }
            });
            
            dataFile.addEventListener('change', () => {
                if (dataFile.files.length > 0) {
                    fileUploadText.textContent = `${dataFile.files.length} arquivo(s) selecionado(s)`;
                } else {
                    fileUploadText.textContent = 'Clique ou arraste o(s) arquivo(s) .dat';
                }
            });

            saveToCloudButton.addEventListener('click', async () => { if (allFlightData.length === 0) { showToast('Não há dados para salvar.', 'error'); return; } saveToCloudButton.disabled = true; const originalButtonText = saveToCloudButton.innerHTML; saveToCloudButton.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Salvando...'; lucide.createIcons(); try { const user = auth.currentUser; if (!user) { throw new Error('Sessão expirada. Faça login novamente.'); } const token = await user.getIdToken(); const payload = { records: allFlightData, icao_code: currentIcaoCode, data_date: currentDataDate }; const response = await fetch('/api/save_records', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); const result = await response.json(); if (!response.ok) { throw new Error(result.error || 'Erro ao salvar os dados'); } showToast(result.message, 'success'); fetchUploadHistory(); } catch (error) { console.error('Erro ao salvar:', error); showToast(error.message, 'error'); saveToCloudButton.disabled = false; } finally { saveToCloudButton.innerHTML = originalButtonText; lucide.createIcons(); } });
            
            async function fetchUploadHistory() { renderUploadHistory([]); try { const user = auth.currentUser; if (!user) { return; } const token = await user.getIdToken(); const response = await fetch('/api/get_uploads', { headers: { 'Authorization': 'Bearer ' + token } }); if (!response.ok) { throw new Error('Falha ao buscar histórico'); } const uploads = await response.json(); renderUploadHistory(uploads); } catch (error) { console.error('Erro ao buscar histórico:', error); uploadHistoryList.innerHTML = '<p class="text-sm text-red-500 text-center py-4">Erro ao carregar histórico.</p>'; } }
            function renderUploadHistory(uploads) { uploadHistoryList.innerHTML = ''; if (!uploads || uploads.length === 0) { uploadHistoryList.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Nenhum histórico encontrado.</p>'; return; } uploads.forEach(upload => { const item = document.createElement('div'); item.className = 'p-3 rounded-lg flex justify-between items-center group'; const dateStringToUse = upload.dataDate || upload.createdAt; const date = new Date(dateStringToUse); const year = date.getFullYear(); const month = (date.getMonth() + 1).toString().padStart(2, '0'); const icao = upload.icaoCode || '----'; const displayText = `${year}${month}${icao}`; item.innerHTML = ` <div data-upload-id="${upload.uploadId}" class="flex-grow cursor-pointer"> <p class="font-semibold text-sm text-gray-700">${displayText}</p> <p class="text-xs text-gray-500">${upload.recordCount} registros</p> </div> <button class="delete-upload-btn p-2 rounded-full hover:bg-red-100 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity" data-upload-id="${upload.uploadId}"> <i data-lucide="trash-2" class="w-4 h-4"></i> </button>`; uploadHistoryList.appendChild(item); }); lucide.createIcons(); }
            async function loadRecords(uploadId) { showToast('Carregando registros...', 'success'); try { const user = auth.currentUser; if (!user) { throw new Error('Sessão expirada. Faça login novamente.'); } const token = await user.getIdToken(); const response = await fetch(`/api/get_records/${uploadId}`, { headers: { 'Authorization': 'Bearer ' + token } }); if (!response.ok) { const err = await response.json(); throw new Error(err.error || "Falha ao carregar registros"); } const records = await response.json(); allFlightData = records; currentIcaoCode = null; currentDataDate = null; updateDataPeriodDisplay(allFlightData.length > 0 ? allFlightData[0].timestamp : null, allFlightData.length > 0 ? allFlightData[0].timestamp : null); applyFiltersAndRender(); updateStatus(); showToast(`${records.length} registros carregados do histórico!`, 'success'); } catch (error) { console.error('Erro ao carregar registros:', error); showToast(error.message, 'error'); } }
            async function deleteUpload(uploadId) { if (!confirm('Tem certeza que deseja apagar este registro? A ação não pode ser desfeita.')) { return; } showToast('Apagando registro...', 'success'); try { const user = auth.currentUser; if (!user) { throw new Error('Sessão expirada.'); } const token = await user.getIdToken(); const response = await fetch(`/api/delete_upload/${uploadId}`, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } }); const result = await response.json(); if (!response.ok) { throw new Error(result.error || "Falha ao apagar registro"); } showToast(result.message, 'success'); fetchUploadHistory(); } catch (error) { console.error('Erro ao apagar registro:', error); showToast(error.message, 'error'); } }
            uploadHistoryList.addEventListener('click', (e) => { const deleteButton = e.target.closest('.delete-upload-btn'); const loadItem = e.target.closest('div[data-upload-id]'); if (deleteButton) { deleteUpload(deleteButton.dataset.uploadId); } else if (loadItem) { loadRecords(loadItem.dataset.uploadId); } });
            
            function applyFiltersAndRender() { let filteredData = [...allFlightData]; let activeFilters = 0; tableFilters.forEach(input => { const column = input.dataset.column; const value = input.value.trim().toUpperCase(); if (value) { filteredData = filteredData.filter(f => { if (column === 'timestamp' && f.timestamp) { return formatDateTime(f.timestamp).includes(value); } return f[column]?.toUpperCase().includes(value); }); activeFilters++; } }); document.getElementById('active-filters').textContent = activeFilters; renderTable(filteredData); renderStats(filteredData); renderCharts(filteredData); checkForAnomalies(filteredData); }
            tableFilters.forEach(input => { input.addEventListener('input', applyFiltersAndRender); });
            
            function renderTable(data) {
                tableBody.innerHTML = '';
                if (data.length === 0) {
                    const emptyMessage = allFlightData.length > 0 ? `<i data-lucide="search-x" class="w-12 h-12 mx-auto mb-4 text-gray-300"></i><p>Nenhum registro corresponde ao filtro.</p>` : `<i data-lucide="inbox" class="w-12 h-12 mx-auto mb-4 text-gray-300"></i><p>Aguardando análise de período...</p>`;
                    tableBody.innerHTML = `<tr><td colspan="8" class="text-center p-12 text-gray-500">${emptyMessage}</td></tr>`;
                    lucide.createIcons(); return;
                }
                const rows = data.map((flight) => { const formattedDateTime = formatDateTime(flight.timestamp); return `<tr class="table-row border-b border-gray-100"><td class="px-4 py-3 font-medium">${formattedDateTime}</td><td class="px-4 py-3">${flight.matricula || 'N/A'}</td><td class="px-4 py-3">${flight.tipo_aeronave || 'N/A'}</td><td class="px-4 py-3">${flight.flight_class || 'N/A'}</td><td class="px-4 py-3">${flight.origem || 'N/A'}</td><td class="px-4 py-3">${flight.destino || 'N/A'}</td><td class="px-4 py-3"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${flight.regra_voo === 'IFR' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${flight.regra_voo || 'N/A'}</span></td><td class="px-4 py-3">${flight.pista || '-'}</td></tr>`; }).join('');
                tableBody.innerHTML = rows;
            }
            function renderStats(data) { const commercialPrefixes = ['AZU', 'GLO', 'TAM']; const voosComerciais = data.filter(f => commercialPrefixes.some(p => f.matricula?.startsWith(p))).length; const sobrevoos = data.filter(f => f.origem !== 'SBIZ' && f.destino !== 'SBIZ').length; let horarioPico = '-'; if (data.length > 0) { const hourlyCounts = data.reduce((acc, flight) => { if(!flight.timestamp) return acc; const hour = new Date(flight.timestamp).getUTCHours(); acc[hour] = (acc[hour] || 0) + 1; return acc; }, {}); const counts = Object.values(hourlyCounts); const hours = Object.keys(hourlyCounts); if(counts.length > 0) { const maxCount = Math.max(...counts); horarioPico = hours.filter(h => hourlyCounts[h] === maxCount).join(', ') + 'h'; } } animateNumber('total-voos', data.length); animateNumber('voos-comerciais', voosComerciais); animateNumber('sobrevoos', sobrevoos); document.getElementById('horario-pico').textContent = horarioPico; }
            function animateNumber(elementId, targetValue) { const element = document.getElementById(elementId); const currentValue = parseInt(element.textContent) || 0; if (currentValue === targetValue) { return; } const difference = targetValue - currentValue; let step = Math.ceil(Math.abs(difference) / 20); if (difference < 0) { step = -step; } const nextValue = currentValue + step; if ((step > 0 && nextValue >= targetValue) || (step < 0 && nextValue <= targetValue)) { element.textContent = targetValue; } else { element.textContent = nextValue; setTimeout(() => animateNumber(elementId, targetValue), 25); } }
            function renderCharts(data) { renderRuleAndDestCharts(data); renderHourlyChart(data); renderDayOfWeekChart(data); renderMonthlyTrendsChart(data); renderRunwayUsageChart(data); renderTopItemsChart(data, 'tipo_aeronave', 'aircraftTypesChart', 5); renderTopItemsChart(data, 'responsavel', 'operatorChart', 5); renderTrafficProjectionChart(data); }
            function renderRuleAndDestCharts(data) { const ruleCounts = data.reduce((acc, flight) => { const rule = flight.regra_voo || 'N/A'; acc[rule] = (acc[rule] || 0) + 1; return acc; }, {}); if (flightsByRuleChart) flightsByRuleChart.destroy(); flightsByRuleChart = new Chart(document.getElementById('flightsByRuleChart'), { type: 'doughnut', data: { labels: Object.keys(ruleCounts), datasets: [{ data: Object.values(ruleCounts), backgroundColor: ['rgba(102, 126, 234, 0.8)','rgba(16, 163, 74, 0.8)','rgba(239, 68, 68, 0.8)','rgba(245, 158, 11, 0.8)'], borderWidth: 0, hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } } } } }); const destCounts = data.reduce((acc, flight) => { const dest = flight.destino || 'N/A'; acc[dest] = (acc[dest] || 0) + 1; return acc; }, {}); delete destCounts['SBIZ']; const topDests = Object.entries(destCounts).sort(([,a], [,b]) => b - a).slice(0, 8); if (flightsByDestChart) flightsByDestChart.destroy(); flightsByDestChart = new Chart(document.getElementById('flightsByDestChart'), { type: 'bar', data: { labels: topDests.map(([dest]) => dest), datasets: [{ data: topDests.map(([,count]) => count), backgroundColor: 'rgba(102, 126, 234, 0.8)', borderRadius: 6, borderSkipped: false }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.05)' } }, x: { grid: { display: false } } } } }); }
            function renderHourlyChart(data) { const hourlyCounts = Array(24).fill(0); data.forEach(flight => { if (flight.timestamp) { const hour = new Date(flight.timestamp).getUTCHours(); hourlyCounts[hour]++; } }); if (hourlyFlightsChart) hourlyFlightsChart.destroy(); hourlyFlightsChart = new Chart(document.getElementById('hourlyFlightsChart'), { type: 'line', data: { labels: Array.from({length: 24}, (_, i) => `${i.toString().padStart(2, '0')}:00`), datasets: [{ label: 'Voos por Hora', data: hourlyCounts, borderColor: 'rgba(102, 126, 234, 1)', backgroundColor: 'rgba(102, 126, 234, 0.1)', fill: true, tension: 0.4, pointBackgroundColor: 'rgba(102, 126, 234, 1)', pointBorderColor: '#fff', pointBorderWidth: 2, pointRadius: 4, pointHoverRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.05)' } }, x: { grid: { color: 'rgba(0, 0, 0, 0.05)' } } } } }); }
            function renderDayOfWeekChart(data) { const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb']; const dayCounts = Array(7).fill(0); data.forEach(flight => { if (flight.timestamp) { const day = new Date(flight.timestamp).getUTCDay(); dayCounts[day]++; } }); if (dayOfWeekChart) dayOfWeekChart.destroy(); dayOfWeekChart = new Chart(document.getElementById('dayOfWeekChart'), { type: 'bar', data: { labels: days, datasets: [{ label: 'Voos', data: dayCounts, backgroundColor: 'rgba(239, 68, 68, 0.8)', borderRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } } }); }
            function renderMonthlyTrendsChart(data) { const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez']; const monthCounts = Array(12).fill(0); data.forEach(flight => { if (flight.timestamp) { const month = new Date(flight.timestamp).getUTCMonth(); monthCounts[month]++; } }); if (monthlyTrendsChart) monthlyTrendsChart.destroy(); monthlyTrendsChart = new Chart(document.getElementById('monthlyTrendsChart'), { type: 'line', data: { labels: months, datasets: [{ label: 'Voos', data: monthCounts, borderColor: 'rgba(245, 158, 11, 1)', backgroundColor: 'rgba(245, 158, 11, 0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } } }); }
            function renderRunwayUsageChart(data) { const runwayCounts = data.reduce((acc, flight) => { const runway = flight.pista || 'N/A'; if(runway !== 'N/A' && runway.trim() !== '') acc[runway] = (acc[runway] || 0) + 1; return acc; }, {}); if (runwayUsageChart) runwayUsageChart.destroy(); runwayUsageChart = new Chart(document.getElementById('runwayUsageChart'), { type: 'doughnut', data: { labels: Object.keys(runwayCounts), datasets: [{ data: Object.values(runwayCounts), backgroundColor: ['rgba(59, 130, 246, 0.8)', 'rgba(16, 185, 129, 0.8)', 'rgba(234, 179, 8, 0.8)'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } }); }
            function renderTopItemsChart(data, key, chartId, limit) { const counts = data.reduce((acc, flight) => { const item = flight[key] || 'N/A'; acc[item] = (acc[item] || 0) + 1; return acc; }, {}); delete counts['N/A']; const topItems = Object.entries(counts).sort(([,a],[,b]) => b - a).slice(0, limit); let chartInstance; if (chartId === 'aircraftTypesChart') chartInstance = aircraftTypesChart; if (chartId === 'operatorChart') chartInstance = operatorChart; if (chartInstance) chartInstance.destroy(); chartInstance = new Chart(document.getElementById(chartId), { type: 'bar', data: { labels: topItems.map(([item]) => item), datasets: [{ label: 'Voos', data: topItems.map(([,count]) => count), backgroundColor: 'rgba(139, 92, 246, 0.8)', borderRadius: 6 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } } } }); if (chartId === 'aircraftTypesChart') aircraftTypesChart = chartInstance; if (chartId === 'operatorChart') operatorChart = chartInstance; }
            function renderTrafficProjectionChart(data) { if (trafficProjectionChart) trafficProjectionChart.destroy(); const canvas = document.getElementById('trafficProjectionChart'); const container = canvas.parentElement.parentElement; const monthlyCounts = data.reduce((acc, flight) => { if (!flight.timestamp) return acc; const monthKey = flight.timestamp.slice(0, 7); acc[monthKey] = (acc[monthKey] || 0) + 1; return acc; }, {}); const sortedMonths = Object.keys(monthlyCounts).sort(); if (sortedMonths.length < 2) { container.style.display = 'none'; return; } container.style.display = 'block'; const historicalData = sortedMonths.map(month => monthlyCounts[month]); const regressionData = sortedMonths.map((month, index) => [index, monthlyCounts[month]]); const regressionLine = ss.linearRegressionLine(ss.linearRegression(regressionData)); const projectionLabels = []; const projectionData = []; const lastHistoricalValue = historicalData[historicalData.length - 1]; for (let i = 0; i < 3; i++) { const lastDate = new Date(sortedMonths[sortedMonths.length - 1] + '-01T12:00:00Z'); lastDate.setUTCMonth(lastDate.getUTCMonth() + i + 1); projectionLabels.push(lastDate.toLocaleString('pt-BR', { month: 'short', year: '2-digit', timeZone: 'UTC'})); const projectedValue = regressionLine(sortedMonths.length + i); projectionData.push(projectedValue > 0 ? Math.round(projectedValue) : 0); } trafficProjectionChart = new Chart(canvas, { type: 'line', data: { labels: sortedMonths.concat(projectionLabels), datasets: [{ label: 'Histórico Mensal', data: historicalData, borderColor: 'rgba(102, 126, 234, 1)', backgroundColor: 'rgba(102, 126, 234, 0.1)', fill: true, tension: 0.1 }, { label: 'Projeção', data: new Array(historicalData.length - 1).fill(null).concat([lastHistoricalValue], projectionData), borderColor: 'rgba(234, 179, 8, 1)', borderDash: [5, 5], fill: false, tension: 0.1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } }); }
            function checkForAnomalies(data) { anomalyAlertsList.innerHTML = ''; if (data.length < 7) { anomalyAlertsList.innerHTML = '<li>Dados insuficientes para análise.</li>'; return; } const dailyCounts = data.reduce((acc, flight) => { if (!flight.timestamp) return acc; const dayKey = flight.timestamp.slice(0, 10); acc[dayKey] = (acc[dayKey] || 0) + 1; return acc; }, {}); const allCounts = Object.values(dailyCounts); if (allCounts.length < 2) { anomalyAlertsList.innerHTML = '<li>Período muito curto para análise.</li>'; return; } const mean = ss.mean(allCounts); const stdDev = ss.standardDeviation(allCounts); const threshold = 1.5; const anomalies = []; for (const [day, count] of Object.entries(dailyCounts)) { if (count > mean + threshold * stdDev) { anomalies.push({ day, count, type: 'alto' }); } else if (count < mean - threshold * stdDev) { anomalies.push({ day, count, type: 'baixo' }); } } if (anomalies.length === 0) { anomalyAlertsList.innerHTML = '<li><i data-lucide="check-circle" class="w-4 h-4 inline-block mr-2 text-green-500"></i>Nenhuma anomalia significativa detectada.</li>'; lucide.createIcons(); return; } anomalies.sort((a,b) => new Date(a.day) - new Date(b.day)).forEach(anomaly => { const li = document.createElement('li'); const date = new Date(anomaly.day + 'T12:00:00Z').toLocaleDateString('pt-BR', {timeZone: 'UTC'}); const icon = anomaly.type === 'alto' ? '<i data-lucide="arrow-up-circle" class="w-4 h-4 inline-block mr-2 text-red-500"></i>' : '<i data-lucide="arrow-down-circle" class="w-4 h-4 inline-block mr-2 text-blue-500"></i>'; li.innerHTML = `${icon} <strong>Volume ${anomaly.type}:</strong> ${date} teve <strong>${anomaly.count}</strong> voos (média de ${Math.round(mean)}).`; anomalyAlertsList.appendChild(li); }); lucide.createIcons(); }
            
            function toggleLoading(isLoading) { uploadButton.disabled = isLoading; buttonText.textContent = isLoading ? 'Processando...' : 'Processar Arquivo(s)'; loadingSpinner.classList.toggle('hidden', !isLoading); }
            function updateStatus() { document.getElementById('loaded-count').textContent = allFlightData.length; document.getElementById('last-update').textContent = new Date().toLocaleTimeString('pt-BR'); }
            downloadCsvButton.addEventListener('click', () => { if (allFlightData.length === 0) { showToast('Nenhum dado disponível para download.', 'error'); return; } const headers = ['Data/Hora', 'Matrícula', 'Tipo Aeronave', 'Tipo Voo', 'Origem', 'Destino', 'Regra', 'Pista']; const csvContent = [ headers.join(','), ...allFlightData.map(flight => [ flight.timestamp || '', flight.matricula || '', flight.tipo_aeronave || '', flight.flight_class || '', flight.origem || '', flight.destino || '', flight.regra_voo || '', flight.pista || '' ].join(',')) ].join('\n'); const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `dados_voo_${new Date().toISOString().split('T')[0]}.csv`; link.click(); showToast('Arquivo CSV baixado com sucesso!', 'success'); });
            updateStatus();
        });
    </script>
</body>
</html>
